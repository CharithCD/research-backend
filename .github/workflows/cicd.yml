name: build-and-deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: backend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/research-backend:main
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/research-backend:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/research-backend:buildcache,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy on droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            set -Eeuo pipefail
            mkdir -p /opt/research-backend
            cd /opt/research-backend

            docker --version
            docker compose version

            # Write/update docker-compose.yml (idempotent).
            # NOTE: this uses <<-'YAML' so the *tabs* before the closing YAML are allowed.
            cat > docker-compose.yml <<-'YAML'
            services:
              api:
                image: ${DOCKERHUB_USERNAME}/research-backend:main
                container_name: research_backend_api
                env_file:
                  - .env.prod
                ports:
                  - "8000:8000"
                restart: unless-stopped
                environment:
                  HF_HOME: /root/.cache/huggingface
                  NLTK_DATA: /root/nltk_data
                volumes:
                  - hf_cache:/root/.cache/huggingface
                  - data:/app/data
                command: ["sh","-lc","/app/bootstrap_model.sh && exec uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 1"]
            volumes:
              hf_cache:
              data:
            YAML

            # Keep DOCKERHUB_USERNAME in .env for compose substitution
            grep -q '^DOCKERHUB_USERNAME=' .env 2>/dev/null || \
              echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" >> .env

            docker compose pull
            docker compose up -d
            docker compose ps
